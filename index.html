<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#000000">
    <meta name="description" content="Simple finance tracker for students">
    <title>Finance Tracker</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            max-width: 428px;
            margin: 0 auto;
            min-height: 100vh;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid #111;
        }

        .wallet-icon {
            width: 32px;
            height: 32px;
        }

        .edit-btn {
            background: #111;
            border: 1px solid #222;
            color: #fff;
            padding: 10px 20px;
            border-radius: 12px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .edit-btn:hover {
            background: #1a1a1a;
            border-color: #333;
        }

        .balance-section {
            margin-bottom: 40px;
            text-align: center;
            padding: 30px 0;
        }

        .balance-label {
            color: #666;
            font-size: 13px;
            margin-bottom: 12px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            font-weight: 500;
        }

        .balance-amount {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 20px;
            letter-spacing: -2px;
        }

        .action-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 40px;
        }

        .action-card {
            background: #0a0a0a;
            border: 1px solid #111;
            border-radius: 16px;
            padding: 24px 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-card:hover {
            background: #111;
            border-color: #222;
            transform: translateY(-2px);
        }

        .action-icon {
            width: 28px;
            height: 28px;
            margin-bottom: 16px;
        }

        .add-money { color: #4ade80; }
        .spending { color: #ef4444; }

        .action-label {
            color: #666;
            font-size: 12px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .action-amount {
            font-size: 22px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            letter-spacing: -0.5px;
        }

        .transactions-list {
            margin-bottom: 40px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #444;
        }

        .empty-title {
            font-size: 15px;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .empty-subtitle {
            font-size: 13px;
            color: #333;
        }

        .transaction-item {
            background: #0a0a0a;
            border: 1px solid #111;
            border-radius: 12px;
            padding: 16px 18px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .transaction-item:hover {
            background: #111;
            border-color: #222;
        }

        .transaction-info {
            flex: 1;
        }

        .transaction-category {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
            letter-spacing: -0.3px;
        }

        .transaction-date {
            font-size: 11px;
            color: #555;
            font-weight: 500;
        }

        .transaction-amount {
            font-size: 16px;
            font-weight: 700;
            letter-spacing: -0.3px;
        }

        .budget-item {
            background: #0a0a0a;
            border: 1px solid #111;
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 8px;
            position: relative;
            transition: all 0.2s;
        }

        .budget-item:hover {
            background: #111;
            border-color: #222;
        }

        .budget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
        }

        .budget-name {
            font-size: 15px;
            font-weight: 600;
            letter-spacing: -0.3px;
        }

        .budget-amount {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }

        .progress-bar {
            background: #111;
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s;
        }

        .add-btn {
            position: fixed;
            bottom: 30px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: #fff;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(255,255,255,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .add-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 32px rgba(255,255,255,0.2);
        }

        .add-btn svg {
            stroke: #000;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #0a0a0a;
            border: 1px solid #111;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 22px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .close-btn {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 0;
            font-size: 24px;
            transition: color 0.2s;
        }

        .close-btn:hover {
            color: #999;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            color: #666;
            font-size: 13px;
            margin-bottom: 8px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input {
            width: 100%;
            background: #000;
            border: 1px solid #222;
            color: #fff;
            padding: 14px;
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #4ade80;
            background: #0a0a0a;
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .category-btn {
            background: #000;
            border: 1px solid #222;
            color: #fff;
            padding: 14px 12px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .category-btn.active {
            border-color: #4ade80;
            background: rgba(74, 222, 128, 0.08);
        }

        .category-btn:hover {
            background: #0a0a0a;
            border-color: #333;
        }

        .submit-btn {
            width: 100%;
            background: #fff;
            border: none;
            color: #000;
            padding: 16px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.2s;
        }

        .submit-btn:hover {
            background: #f5f5f5;
            transform: translateY(-1px);
        }

        .stats-section {
            margin-top: 40px;
            padding-top: 40px;
            border-top: 1px solid #111;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: #0a0a0a;
            border: 1px solid #111;
            border-radius: 12px;
            padding: 20px 18px;
            transition: all 0.2s;
        }

        .stat-card:hover {
            background: #111;
            border-color: #222;
        }

        .stat-label {
            color: #666;
            font-size: 11px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .add-plan-btn {
            background: #111;
            border: 1px solid #222;
            color: #4ade80;
            padding: 10px 18px;
            border-radius: 12px;
            font-size: 13px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .add-plan-btn:hover {
            background: #1a1a1a;
            border-color: #333;
        }

        .delete-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(239, 68, 68, 0.95);
            border-radius: 12px;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10;
            backdrop-filter: blur(10px);
        }

        .delete-overlay.active {
            display: flex;
        }

        .delete-btn-overlay {
            background: #fff;
            border: none;
            color: #ef4444;
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .delete-btn-overlay:hover {
            transform: scale(1.05);
        }

        .chart-container {
            background: #0a0a0a;
            border: 1px solid #111;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .chart-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #fff;
            letter-spacing: -0.3px;
        }

        .chart-canvas {
            width: 100%;
            height: 200px;
            position: relative;
        }

        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-top: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .legend-label {
            color: #999;
            font-weight: 500;
        }

        .legend-value {
            color: #fff;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <div style="color: #888; font-size: 14px; margin-bottom: 4px;">Good day,</div>
            <div style="font-size: 20px; font-weight: 700;" id="userName">Friend</div>
        </div>
        <button class="edit-btn" onclick="openResetModal()">Reset</button>
    </div>

    <div class="balance-section">
        <div class="balance-label">Current Balance</div>
        <div class="balance-amount" id="balanceDisplay">$0.00 JMD</div>
    </div>

    <div class="action-cards">
        <div class="action-card" onclick="openAddMoneyModal()">
            <svg class="action-icon add-money" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 8v8m-4-4h8"/>
            </svg>
            <div class="action-label">Add Money</div>
            <div class="action-amount">+</div>
        </div>
        <div class="action-card">
            <svg class="action-icon spending" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 6v6l4 2"/>
            </svg>
            <div class="action-label">Spending</div>
            <div class="action-amount" id="totalSpending">$0.00 JMD</div>
        </div>
    </div>

    <div class="section-title">Recent Transactions</div>
    <div class="transactions-list" id="transactionsList">
        <div class="empty-state">
            <div class="empty-title">No transactions yet</div>
            <div class="empty-subtitle">Add your first expense below</div>
        </div>
    </div>

    <div class="chart-container" id="chartContainer" style="display: none;">
        <div class="chart-title">Spending by Category</div>
        <canvas id="spendingChart" class="chart-canvas"></canvas>
        <div class="chart-legend" id="chartLegend"></div>
    </div>

    <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
        <span>Savings Plans</span>
        <button class="add-plan-btn" onclick="openSavingsModal()">+ Add Plan</button>
    </div>
    <div id="savingsList">
        <div class="empty-state">
            <div class="empty-title">No savings plans</div>
            <div class="empty-subtitle">Create your first savings plan</div>
        </div>
    </div>

    <div class="stats-section">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Planned</div>
                <div class="stat-value" id="totalPlanned">$0.00 JMD</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Remaining</div>
                <div class="stat-value" id="remaining">$0.00 JMD</div>
            </div>
        </div>
    </div>

    <div style="text-align: center; padding: 40px 20px 80px; color: #444; font-size: 12px;">
        Made by theoneandonlyJev
    </div>

    <button class="add-btn" onclick="openExpenseModal()">
        <svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="3">
            <path d="M12 5v14m-7-7h14"/>
        </svg>
    </button>

    <!-- Balance Modal -->
    <div class="modal" id="balanceModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Set Balance</div>
                <button class="close-btn" onclick="closeModal('balanceModal')">‚úï</button>
            </div>
            <div style="background: #2a1a1a; border-left: 3px solid #ef4444; padding: 12px; border-radius: 8px; margin-bottom: 20px; color: #fca5a5; font-size: 14px;">
                ‚ö†Ô∏è Warning: Changing your balance will reset all transactions and savings plans!
            </div>
            <div class="form-group">
                <label class="form-label">Amount</label>
                <input type="number" class="form-input" id="balanceInput" placeholder="0.00" step="0.01">
            </div>
            <button class="submit-btn" onclick="confirmBalanceChange()">Save Balance</button>
        </div>
    </div>

    <!-- Welcome Modal -->
    <div class="modal" id="welcomeModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Welcome! üëã</div>
            </div>
            <div class="form-group">
                <label class="form-label">What's your name?</label>
                <input type="text" class="form-input" id="nameInput" placeholder="Enter your name">
            </div>
            <div class="form-group">
                <label class="form-label">Starting Balance</label>
                <input type="number" class="form-input" id="initialBalanceInput" placeholder="0.00" step="0.01">
            </div>
            <button class="submit-btn" onclick="saveInitialSetup()">Get Started</button>
        </div>
    </div>

    <!-- Reset Confirmation Modal -->
    <div class="modal" id="resetModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" onclick="openAdminMenu()" style="cursor: pointer; user-select: none;">Reset Everything?</div>
                <button class="close-btn" onclick="closeModal('resetModal')">‚úï</button>
            </div>
            <p style="color: #999; margin-bottom: 20px;">This will permanently delete all your data including transactions, savings plans, and reset your balance. This action cannot be undone.</p>
            <div style="display: flex; gap: 10px;">
                <button class="submit-btn" style="background: #333; color: #fff;" onclick="closeModal('resetModal')">Cancel</button>
                <button class="submit-btn" style="background: #ef4444;" onclick="confirmReset()">Yes, Reset Everything</button>
            </div>
        </div>
    </div>

    <!-- Admin Menu Modal -->
    <div class="modal" id="adminModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Admin Menu üîß</div>
                <button class="close-btn" onclick="closeModal('adminModal')">‚úï</button>
            </div>
            <div style="margin-bottom: 20px;">
                <div style="color: #888; font-size: 14px; margin-bottom: 12px;">Export Options</div>
                <button class="submit-btn" style="background: #4ade80; margin-bottom: 10px;" onclick="downloadTransactionsCSV()">üì• Download Transactions (CSV)</button>
                <button class="submit-btn" style="background: #60a5fa; margin-bottom: 10px;" onclick="downloadTransactionsJSON()">üì• Download Transactions (JSON)</button>
                <button class="submit-btn" style="background: #a78bfa;" onclick="downloadAllData()">üì• Download All Data (JSON)</button>
            </div>
            <div style="border-top: 1px solid #333; padding-top: 20px; margin-top: 20px;">
                <div style="color: #888; font-size: 14px; margin-bottom: 8px;">Statistics</div>
                <div style="color: #fff; font-size: 14px; line-height: 1.8;">
                    <div>Total Transactions: <span style="color: #4ade80;" id="adminTotalTransactions">0</span></div>
                    <div>Total Income: <span style="color: #4ade80;" id="adminTotalIncome">$0.00 JMD</span></div>
                    <div>Total Expenses: <span style="color: #ef4444;" id="adminTotalExpenses">$0.00 JMD</span></div>
                    <div>Savings Plans: <span style="color: #60a5fa;" id="adminSavingsPlans">0</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Password Modal -->
    <div class="modal" id="adminPasswordModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Admin Access üîê</div>
                <button class="close-btn" onclick="closeModal('adminPasswordModal')">‚úï</button>
            </div>
            <div class="form-group">
                <label class="form-label">Enter Password</label>
                <input type="password" class="form-input" id="adminPasswordInput" placeholder="Enter password" maxlength="4">
            </div>
            <button class="submit-btn" onclick="checkAdminPassword()">Unlock</button>
        </div>
    </div>

    <!-- Confirm Reset Modal -->
    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Are You Sure?</div>
                <button class="close-btn" onclick="closeModal('confirmModal')">‚úï</button>
            </div>
            <p style="color: #999; margin-bottom: 20px;">This will permanently delete all your transactions and savings plans. This action cannot be undone.</p>
            <div style="display: flex; gap: 10px;">
                <button class="submit-btn" style="background: #333; color: #fff;" onclick="closeModal('confirmModal')">Cancel</button>
                <button class="submit-btn" style="background: #ef4444;" onclick="setBalance()">Yes, Reset Everything</button>
            </div>
        </div>
    </div>

    <!-- Add Money Modal -->
    <div class="modal" id="addMoneyModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Add Money</div>
                <button class="close-btn" onclick="closeModal('addMoneyModal')">‚úï</button>
            </div>
            <div class="form-group">
                <label class="form-label">Amount</label>
                <input type="number" class="form-input" id="addMoneyInput" placeholder="0.00" step="0.01">
            </div>
            <button class="submit-btn" onclick="addMoney()">Add Money</button>
        </div>
    </div>

    <!-- Expense Modal -->
    <div class="modal" id="expenseModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Add Expense</div>
                <button class="close-btn" onclick="closeModal('expenseModal')">‚úï</button>
            </div>
            <div class="form-group">
                <label class="form-label">Amount</label>
                <input type="number" class="form-input" id="expenseAmount" placeholder="0.00" step="0.01">
            </div>
            <div class="form-group">
                <label class="form-label">Category</label>
                <div class="category-grid">
                    <button class="category-btn" onclick="selectCategory(this, 'Food')">üçî Food</button>
                    <button class="category-btn" onclick="selectCategory(this, 'Transport')">üöó Transport</button>
                    <button class="category-btn" onclick="selectCategory(this, 'Shopping')">üõçÔ∏è Shopping</button>
                    <button class="category-btn" onclick="selectCategory(this, 'Bills')">üì± Bills</button>
                    <button class="category-btn" onclick="selectCategory(this, 'Entertainment')">üéÆ Fun</button>
                    <button class="category-btn" onclick="selectCategory(this, 'Other')">üìå Other</button>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Or Create Custom Category</label>
                <input type="text" class="form-input" id="customCategory" placeholder="e.g., Healthcare, Education...">
            </div>
            <div class="form-group">
                <label class="form-label">Note (Optional)</label>
                <input type="text" class="form-input" id="expenseNote" placeholder="Add a note...">
            </div>
            <button class="submit-btn" onclick="addExpense()">Add Expense</button>
        </div>
    </div>

    <!-- Savings Modal -->
    <div class="modal" id="savingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Create Savings Plan</div>
                <button class="close-btn" onclick="closeModal('savingsModal')">‚úï</button>
            </div>
            <div class="form-group">
                <label class="form-label">Plan Name</label>
                <input type="text" class="form-input" id="savingsName" placeholder="e.g., Vacation, New Car">
            </div>
            <div class="form-group">
                <label class="form-label">Target Amount</label>
                <input type="number" class="form-input" id="savingsTarget" placeholder="0.00" step="0.01">
            </div>
            <div class="form-group">
                <label class="form-label">Current Amount</label>
                <input type="number" class="form-input" id="savingsCurrent" placeholder="0.00" step="0.01" value="0">
            </div>
            <button class="submit-btn" onclick="addSavings()">Create Savings Plan</button>
        </div>
    </div>

    <!-- Add to Savings Modal -->
    <div class="modal" id="addToSavingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Manage <span id="selectedSavingsName"></span></div>
                <button class="close-btn" onclick="closeModal('addToSavingsModal')">‚úï</button>
            </div>
            <div class="form-group">
                <label class="form-label">Amount</label>
                <input type="number" class="form-input" id="addToSavingsAmount" placeholder="0.00" step="0.01">
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="submit-btn" style="background: #ef4444;" onclick="removeMoneyFromSavings()">Remove Money</button>
                <button class="submit-btn" onclick="addMoneyToSavings()">Add Money</button>
            </div>
        </div>
    </div>

    <!-- Delete Savings Confirmation Modal -->
    <div class="modal" id="deleteSavingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Delete Savings Plan?</div>
                <button class="close-btn" onclick="closeModal('deleteSavingsModal')">‚úï</button>
            </div>
            <p style="color: #999; margin-bottom: 8px;">Are you sure you want to delete "<span id="deleteSavingsName" style="color: #fff; font-weight: 600;"></span>"?</p>
            <p style="color: #4ade80; font-size: 14px; margin-bottom: 20px;">$<span id="deleteSavingsAmount"></span> JMD will be returned to your balance.</p>
            <div style="display: flex; gap: 10px;">
                <button class="submit-btn" style="background: #333; color: #fff;" onclick="closeModal('deleteSavingsModal')">Cancel</button>
                <button class="submit-btn" style="background: #ef4444;" onclick="confirmDeleteSavings()">Delete Plan</button>
            </div>
        </div>
    </div>

    <script>
        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker registration failed'));
        }

        let balance = 0;
        let transactions = [];
        let savings = [];
        let selectedCategory = '';
        let selectedSavingsIndex = -1;
        let holdTimer = null;
        let deleteIndex = -1;
        let userName = '';

        // Load data on start
        loadData();

        function loadData() {
            const saved = localStorage.getItem('financeData');
            if (saved) {
                const data = JSON.parse(saved);
                balance = data.balance || 0;
                transactions = data.transactions || [];
                savings = data.savings || [];
                userName = data.userName || '';
            }
            
            // Show welcome modal if first time
            if (!userName) {
                document.getElementById('welcomeModal').classList.add('active');
            } else {
                document.getElementById('userName').textContent = userName;
            }
            
            // Add default savings plans if none exist and balance is set
            if (savings.length === 0 && balance > 0) {
                savings.push({
                    name: 'Savings Goal',
                    target: 10000,
                    current: 0
                });
                savings.push({
                    name: 'Emergency Fund',
                    target: 5000,
                    current: 0
                });
                saveData();
            }
            
            updateDisplay();
        }

        function saveData() {
            localStorage.setItem('financeData', JSON.stringify({
                balance,
                transactions,
                savings,
                userName
            }));
        }

        function updateDisplay() {
            document.getElementById('balanceDisplay').textContent = `JMD${balance.toFixed(2)}`;
            
            const totalSpent = transactions.reduce((sum, t) => t.isIncome ? sum : sum + t.amount, 0);
            document.getElementById('totalSpending').textContent = `JMD${totalSpent.toFixed(2)}`;
            
            updateTransactionsList();
            updateSavingsList();
            updateStats();
        }

        function updateTransactionsList() {
            const list = document.getElementById('transactionsList');
            if (transactions.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-title">No transactions yet</div>
                        <div class="empty-subtitle">Add your first expense below</div>
                    </div>
                `;
            } else {
                list.innerHTML = transactions.slice(-5).reverse().map(t => `
                    <div class="transaction-item">
                        <div class="transaction-info">
                            <div class="transaction-category">${t.category}</div>
                            <div class="transaction-date">${t.date}${t.note ? ' ‚Ä¢ ' + t.note : ''}</div>
                        </div>
                        <div class="transaction-amount" style="color: ${t.isIncome ? '#4ade80' : '#ef4444'}">${t.isIncome ? '+' : '-'}JMD${t.amount.toFixed(2)}</div>
                    </div>
                `).join('');
            }
        }

        function updateSavingsList() {
            const list = document.getElementById('savingsList');
            if (savings.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-title">No savings plans</div>
                        <div class="empty-subtitle">Create your first savings plan</div>
                    </div>
                `;
            } else {
                const colors = ['#4ade80', '#fbbf24', '#f87171', '#60a5fa', '#a78bfa', '#fb923c'];
                list.innerHTML = savings.map((s, i) => {
                    const progress = (s.current / s.target) * 100;
                    return `
                        <div class="budget-item" style="cursor: pointer;" 
                             onmousedown="startHold(${i})" 
                             onmouseup="cancelHold()" 
                             onmouseleave="cancelHold()"
                             ontouchstart="startHold(${i})" 
                             ontouchend="cancelHold()" 
                             ontouchcancel="cancelHold()"
                             onclick="handleSavingsClick(event, ${i})">
                            <div class="budget-header">
                                <div class="budget-name">${s.name}</div>
                                <div class="budget-amount">JMD${s.current.toFixed(2)} / JMD${s.target.toFixed(2)}</div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${Math.min(progress, 100)}%; background: ${colors[i % colors.length]}"></div>
                            </div>
                            <div class="delete-overlay" id="deleteOverlay${i}">
                                <button class="delete-btn-overlay" onclick="event.stopPropagation(); deleteSavingsPlan(${i})">Delete Plan</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function updateStats() {
            const totalPlanned = savings.reduce((sum, s) => sum + s.target, 0);
            document.getElementById('totalPlanned').textContent = `JMD${totalPlanned.toFixed(2)}`;
            document.getElementById('remaining').textContent = `JMD${balance.toFixed(2)}`;
        }

        function openBalanceModal() {
            document.getElementById('balanceInput').value = balance;
            document.getElementById('balanceModal').classList.add('active');
        }

        function openAddMoneyModal() {
            document.getElementById('addMoneyInput').value = '';
            document.getElementById('addMoneyModal').classList.add('active');
        }

        function openExpenseModal() {
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseNote').value = '';
            document.getElementById('customCategory').value = '';
            selectedCategory = '';
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('expenseModal').classList.add('active');
        }

        function openSavingsModal() {
            document.getElementById('savingsName').value = '';
            document.getElementById('savingsTarget').value = '';
            document.getElementById('savingsCurrent').value = '0';
            document.getElementById('savingsModal').classList.add('active');
        }

        function openAddToSavingsModal(index) {
            selectedSavingsIndex = index;
            document.getElementById('selectedSavingsName').textContent = savings[index].name;
            document.getElementById('addToSavingsAmount').value = '';
            document.getElementById('addToSavingsModal').classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function confirmBalanceChange() {
            closeModal('balanceModal');
            document.getElementById('confirmModal').classList.add('active');
        }

        function setBalance() {
            const value = parseFloat(document.getElementById('balanceInput').value);
            if (!isNaN(value) && value >= 0) {
                balance = value;
                transactions = [];
                savings = [];
                saveData();
                updateDisplay();
                closeModal('confirmModal');
            }
        }

        function addMoney() {
            const value = parseFloat(document.getElementById('addMoneyInput').value);
            if (!isNaN(value) && value > 0) {
                balance += value;
                transactions.push({
                    amount: value,
                    category: 'Income',
                    note: 'Money Added',
                    date: new Date().toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }),
                    isIncome: true
                });
                saveData();
                updateDisplay();
                closeModal('addMoneyModal');
            }
        }

        function selectCategory(btn, category) {
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedCategory = category;
            document.getElementById('customCategory').value = '';
        }

        function addExpense() {
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const note = document.getElementById('expenseNote').value;
            const customCat = document.getElementById('customCategory').value.trim();
            
            const category = customCat || selectedCategory;
            
            if (!isNaN(amount) && amount > 0 && category) {
                balance -= amount;
                transactions.push({
                    amount,
                    category: category,
                    note,
                    date: new Date().toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }),
                    isIncome: false
                });
                saveData();
                updateDisplay();
                closeModal('expenseModal');
            }
        }

        function addSavings() {
            const name = document.getElementById('savingsName').value;
            const target = parseFloat(document.getElementById('savingsTarget').value);
            const current = parseFloat(document.getElementById('savingsCurrent').value);
            
            if (name && !isNaN(target) && target > 0 && !isNaN(current) && current >= 0) {
                savings.push({ name, target, current });
                saveData();
                updateDisplay();
                closeModal('savingsModal');
            }
        }

        function addMoneyToSavings() {
            const amount = parseFloat(document.getElementById('addToSavingsAmount').value);
            
            if (!isNaN(amount) && amount > 0 && selectedSavingsIndex >= 0) {
                if (amount <= balance) {
                    savings[selectedSavingsIndex].current += amount;
                    balance -= amount;
                    
                    transactions.push({
                        amount: amount,
                        category: 'Savings',
                        note: `Added to ${savings[selectedSavingsIndex].name}`,
                        date: new Date().toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }),
                        isIncome: false
                    });
                    
                    saveData();
                    updateDisplay();
                    closeModal('addToSavingsModal');
                } else {
                    alert('Insufficient balance!');
                }
            }
        }

        function removeMoneyFromSavings() {
            const amount = parseFloat(document.getElementById('addToSavingsAmount').value);
            
            if (!isNaN(amount) && amount > 0 && selectedSavingsIndex >= 0) {
                if (amount <= savings[selectedSavingsIndex].current) {
                    savings[selectedSavingsIndex].current -= amount;
                    balance += amount;
                    
                    transactions.push({
                        amount: amount,
                        category: 'Savings Withdrawal',
                        note: `Removed from ${savings[selectedSavingsIndex].name}`,
                        date: new Date().toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }),
                        isIncome: true
                    });
                    
                    saveData();
                    updateDisplay();
                    closeModal('addToSavingsModal');
                } else {
                    alert('Insufficient funds in savings plan!');
                }
            }
        }

        function startHold(index) {
            holdTimer = setTimeout(() => {
                document.getElementById(`deleteOverlay${index}`).classList.add('active');
            }, 500); // Hold for 500ms to show delete button
        }

        function cancelHold() {
            if (holdTimer) {
                clearTimeout(holdTimer);
                holdTimer = null;
            }
        }

        function handleSavingsClick(event, index) {
            const overlay = document.getElementById(`deleteOverlay${index}`);
            if (overlay && overlay.classList.contains('active')) {
                overlay.classList.remove('active');
            } else {
                openAddToSavingsModal(index);
            }
        }

        function deleteSavingsPlan(index) {
            deleteIndex = index;
            document.getElementById('deleteSavingsName').textContent = savings[index].name;
            document.getElementById('deleteSavingsAmount').textContent = savings[index].current.toFixed(2);
            
            // Hide the delete overlay
            document.getElementById(`deleteOverlay${index}`).classList.remove('active');
            
            // Show confirmation modal
            document.getElementById('deleteSavingsModal').classList.add('active');
        }

        function confirmDeleteSavings() {
            if (deleteIndex >= 0 && deleteIndex < savings.length) {
                balance += savings[deleteIndex].current;
                savings.splice(deleteIndex, 1);
                deleteIndex = -1;
                saveData();
                updateDisplay();
                closeModal('deleteSavingsModal');
            }
        }

        function saveInitialSetup() {
            const name = document.getElementById('nameInput').value.trim();
            const initialBalance = parseFloat(document.getElementById('initialBalanceInput').value);
            
            if (name && !isNaN(initialBalance) && initialBalance >= 0) {
                userName = name;
                balance = initialBalance;
                document.getElementById('userName').textContent = userName;
                saveData();
                updateDisplay();
                closeModal('welcomeModal');
            } else {
                alert('Please enter your name and a valid balance!');
            }
        }

        function openResetModal() {
            document.getElementById('resetModal').classList.add('active');
        }

        function confirmReset() {
            balance = 0;
            transactions = [];
            savings = [];
            userName = '';
            localStorage.removeItem('financeData');
            closeModal('resetModal');
            document.getElementById('welcomeModal').classList.add('active');
            updateDisplay();
        }

        function openAdminMenu() {
            // Update admin stats
            document.getElementById('adminTotalTransactions').textContent = transactions.length;
            
            const totalIncome = transactions.reduce((sum, t) => t.isIncome ? sum + t.amount : sum, 0);
            const totalExpenses = transactions.reduce((sum, t) => !t.isIncome ? sum + t.amount : sum, 0);
            
            document.getElementById('adminTotalIncome').textContent = `${totalIncome.toFixed(2)} JMD`;
            document.getElementById('adminTotalExpenses').textContent = `${totalExpenses.toFixed(2)} JMD`;
            document.getElementById('adminSavingsPlans').textContent = savings.length;
            
            document.getElementById('adminModal').classList.add('active');
        }

        function downloadTransactionsCSV() {
            if (transactions.length === 0) {
                alert('No transactions to download!');
                return;
            }

            let csv = 'Date,Category,Amount (JMD),Type,Note\n';
            transactions.forEach(t => {
                const type = t.isIncome ? 'Income' : 'Expense';
                const note = (t.note || '').replace(/,/g, ';'); // Replace commas in notes
                csv += `${t.date},${t.category},${t.amount.toFixed(2)},${type},"${note}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `transactions_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function downloadTransactionsJSON() {
            if (transactions.length === 0) {
                alert('No transactions to download!');
                return;
            }

            const dataStr = JSON.stringify(transactions, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `transactions_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function downloadAllData() {
            const allData = {
                userName,
                balance,
                transactions,
                savings,
                exportDate: new Date().toISOString(),
                summary: {
                    totalTransactions: transactions.length,
                    totalIncome: transactions.reduce((sum, t) => t.isIncome ? sum + t.amount : sum, 0),
                    totalExpenses: transactions.reduce((sum, t) => !t.isIncome ? sum + t.amount : sum, 0),
                    savingsPlans: savings.length,
                    totalSaved: savings.reduce((sum, s) => sum + s.current, 0)
                }
            };

            const dataStr = JSON.stringify(allData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `finance_tracker_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function updateChart() {
            const expenses = transactions.filter(t => !t.isIncome);
            
            if (expenses.length === 0) {
                document.getElementById('chartContainer').style.display = 'none';
                return;
            }

            document.getElementById('chartContainer').style.display = 'block';

            // Group by category
            const categoryTotals = {};
            expenses.forEach(t => {
                categoryTotals[t.category] = (categoryTotals[t.category] || 0) + t.amount;
            });

            // Sort and get top 5
            const sortedCategories = Object.entries(categoryTotals)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            const canvas = document.getElementById('spendingChart');
            const ctx = canvas.getContext('2d');
            const width = canvas.parentElement.clientWidth;
            const height = 200;
            canvas.width = width;
            canvas.height = height;

            ctx.clearRect(0, 0, width, height);

            const total = sortedCategories.reduce((sum, [, amount]) => sum + amount, 0);
            const colors = ['#4ade80', '#60a5fa', '#a78bfa', '#fbbf24', '#ef4444'];

            // Draw pie chart
            let currentAngle = -Math.PI / 2;
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = Math.min(width, height) / 2 - 20;

            sortedCategories.forEach(([category, amount], index) => {
                const sliceAngle = (amount / total) * 2 * Math.PI;
                
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.lineTo(centerX, centerY);
                ctx.fillStyle = colors[index];
                ctx.fill();

                currentAngle += sliceAngle;
            });

            // Update legend
            const legend = document.getElementById('chartLegend');
            legend.innerHTML = sortedCategories.map(([category, amount], index) => {
                const percentage = ((amount / total) * 100).toFixed(1);
                return `
                    <div class="legend-item">
                        <div class="legend-color" style="background: ${colors[index]}"></div>
                        <div class="legend-label">${category}</div>
                        <div class="legend-value">${percentage}%</div>
                    </div>
                `;
            }).join('');
        }
    </script>
</body>
</html>
